### DNS污染与DNS劫持

问题现象
``` shell
时间戳                  源IP:端口          目标IP:端口        标志位       序列号/确认号          窗口大小  长度  其他信息
---------------------- --------------- --------------- ----------- ------------------- --------- ------- ---------
[Frame 1]              192.168.61.128:45484 → 34.92.248.74:443   [SYN]       Seq=0               Win=64240 Len=0       
[Frame 2]              34.92.248.74:443   → 192.168.61.128:45484 [SYN, ACK]  Seq=0, Ack=1         Win=...    ...       
[Frame 3]              192.168.61.128:4086  → 34.92.248.74:443   [SYN]       Seq=0               Win=64240 Len=12      
[Frame 4]              34.92.248.74:443   → 192.168.61.128:4086  [SYN, ACK]  Seq=0, Ack=1         Win=...    ...       
[Frame 5]              192.168.61.128:40092 → 34.92.248.74:443   [SYN]       Seq=0               Win=64240 Len=16      
[Frame 6]              34.92.248.74:443   → 192.168.61.128:40092 [SYN, ACK]  Seq=0, Ack=1         Win=...    ...       
[Frame 7]              192.168.61.128:34900 → 8.135.15.43:443    [SYN]       Seq=0               Win=64240 Len=0       
[Frame 8]              8.135.15.43:443    → 192.168.61.128:34900 [RST, ACK]  Seq=1, Ack=1         Win=...    ...       
```

异常连接：向未知IP发送SYN后收到RST
- **源IP**：192.168.61.128（本地设备）  
- **目标IP**：8.135.15.43（未知IP，非预期服务器）  
- **端口**：443（HTTPS端口）  
- **标志位**：  
  - 本地先发`[SYN]`尝试建立连接（Frame 7）  
  - 对端返回`[RST, ACK]`（Frame 8），表示拒绝连接  

#### **RST响应原因**
1. **DNS污染/劫持**：  
   本地设备通过被污染的DNS服务器解析域名时，获取到错误的IP地址（8.135.15.43），导致连接到非预期服务器。  
2. **目标服务器不可达**：  
   8.135.15.43可能是一个无效或恶意IP，无对应的HTTPS服务，因此直接返回RST断开连接。

| **问题类型**   | **攻击原理**                                                                 | **技术实现**                                                                 | **典型场景**                     |
|----------------|-----------------------------------------------------------------------------|-----------------------------------------------------------------------------|----------------------------------|
| **DNS污染**    | 攻击者在DNS服务器缓存中注入伪造的IP记录，导致客户端获取错误解析结果          | 通过中间人攻击修改DNS响应包，或利用DNS服务器漏洞污染缓存                    | 访问境外网站时返回错误IP         |
| **DNS劫持**    | 攻击者直接篡改DNS服务器的权威映射表，强制解析到指定IP（甚至恶意钓鱼服务器）    | 控制本地DNS服务器、运营商DNS服务器或伪造DNS响应包                            | 访问银行网站时被导向钓鱼页面     |

网络故障表现与解决方案

| **问题类型**   | **典型报错信息**                | **网络行为特征**                          | **底层原因**                          | **解决方案**                                                                 |
|----------------|---------------------------------|-------------------------------------------|---------------------------------------|-----------------------------------------------------------------------------|
| **DNS污染**    | `Connection refused`<br>`Timeout` | 客户端无法建立TCP连接，或连接到错误IP后被拒绝 | 缓存中的IP与真实服务器不匹配          | 1. 使用**DOH（DNS over HTTPS）**<br>2. 配置可信公共DNS（如1.1.1.1/8.8.8.8）<br>3. 启用VPN加密通道 |
| **DNS劫持**    | `Connection reset`<br>`Timeout`  | 连接到劫持IP后，对方主动断开连接（返回RST包） | 解析结果被强制指向恶意或不可用IP      | 1. 使用**加密DNS（DOH/DOT）**<br>2. 手动指定境外DNS服务器（如Cloudflare Warp）<br>3. 使用区块链DNS（如Handshake） |


#### 三、关键技术细节

##### 1. **DNS污染的防御难点**
- **污染方式**：
  - 基于关键字过滤（如包含`github.com`的查询返回错误IP）
  - 缓存投毒（利用DNS协议无状态特性伪造响应包）
- **DOH的局限性**：
  - 运营商可能伪装成合法DOH服务器返回错误结果（需验证服务器证书）
  - 需客户端支持（浏览器/系统级别配置）

##### 2. **DNS劫持的深层威胁**
- **攻击链**：
  ```
  用户请求 → 本地DNS服务器（被劫持）→ 返回伪造IP → 连接到钓鱼服务器 → 数据窃取
  ```
- **防御关键点**：
  - **加密通道**：DOH/DOT对DNS查询进行TLS加密，防止中间人篡改
  - **多路径验证**：结合HTTP DNS（如阿里云HTTP DNS）绕过本地DNS解析